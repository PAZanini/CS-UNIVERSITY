<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/style_dash.css" />
    <title>CS UNIVERSITY</title>
  </head>
  <body>
    <div id="div_nav">
      <h1>CS UNIVERSITY</h1>
      <div id="div_nav_misc">
        <div id="div_dashboard">
          <a style="text-decoration: none" href="dashboard.html">
            <h3>Dashboard</h3>
          </a>
        </div>
        <div id="div_drop_util" class="dropdown">
          <div id="div_util">
            <a href="util.html" class="dropbtn">
              <h3>Utilitarias</h3>
            </a>
          </div>
          <div id="div_drop_content" class="dropdown-content">
            <a href="mirage.html">Mirage</a>
          </div>
        </div>
        <div id="div_drop_guias" class="dropdown">
          <div id="div_guias">
            <a href="aulas.html" class="dropbtn">
              <h3>Guias</h3>
            </a>
          </div>
          <div id="div_guia_contet" class="dropdown-content">
            <a href="movimetacao.html">Movimentação</a>
            <a href="awper.html">AWPER perfeito</a>
            <a href="pistol.html">Round Pistol</a>
          </div>
        </div>
        <div id="div_drop_mira" class="dropdown">
          <div id="div_mira">
            <a href="memoria.html" class="dropbtn">
              <h3>Mira</h3>
            </a>
          </div>
          <div id="div_mira_content" class="dropdown-content">
            <a href="memoria.html">Memoria Muscular</a>
            <a href="kovaaks.html">Kovaaks</a>
            <a href="tension.html">Tension Manegment</a>
          </div>
        </div>
      </div>
      <div class="hello">
        <img src="" alt="" />
        <span id="b_user">Usuario</span>
      </div>
    </div>
    <main>
      <div id="div_sup">
        <div id="div_grafico">
          <div id="div_voltaic">
            <p>
              Coloque seus scores da <a href="https://voltaic.gg/">voltaic</a>
            </p>
            <input class="input" id="inp_static" placeholder="static" />
            <input class="input" id="inp_dynamic" placeholder="dynamic" />
            <input class="input" id="inp_speed" placeholder="speed" />
            <input class="input" id="inp_evasive" placeholder="evasive" />
            <input class="input" id="inp_smooth" placeholder="smooth" />
            <input
              class="input"
              id="inp_reactive"
              placeholder="reactive"
              type="text"
            />
            <button id="btn_voltaic" onclick="voltaic()">Enviar</button>
          </div>
          <div id="div_chart">
            <canvas id="chart_avg"></canvas>
          </div>
        </div>
        <div id="div_sup_lat">
          <div id="div_static">
            <div id="div_sup_static" class="kpi_sup">Static</div>
            <div id="div_kpi_static" class="kpi"></div>
          </div>
          <div id="div_dynamic">
            <div id="div_sup_dynamic" class="kpi_sup">Dynamic</div>
            <div id="div_kpi_dynamic" class="kpi"></div>
          </div>
        </div>
      </div>
      <div id="div_inf">
        <div id="div_speed">
          <div id="div_sup_speed" class="kpi_sup">Speed</div>
          <div id="div_kpi_speed" class="kpi"></div>
        </div>
        <div id="div_evasive">
          <div id="div_sup_evasive" class="kpi_sup">Evasive</div>
          <div id="div_kpi_evasive" class="kpi"></div>
        </div>
        <div id="div_smooth">
          <div id="div_sup_smooth" class="kpi_sup">Smooth</div>
          <div id="div_kpi_smooth" class="kpi"></div>
        </div>
        <div id="div_rective">
          <div id="div_sup_reactive" class="kpi_sup">Reactive</div>
          <div id="div_kpi_reactive" class="kpi"></div>
        </div>
      </div>
    </main>
  </body>
</html>

<script>
  // atlGrafico(sessionStorage.ID_USUARIO);
  // b_user.innerHTML = sessionStorage.NOME_USUARIO;

  function atlGrafico(idusuario) {
    fetch(`/usuarios/atlGrafico`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idusuario: idusuario,
      }),
    })
      .then((resposta) => {
        resposta
          .json()
          .then((dados) => {
            "";
            if (dados[0].static < 950) {
              div_kpi_static.innerHTML = `<span class="silver">  ${dados[0].static} </span>`;
            } else if (dados[0].static < 1300) {
              div_kpi_static.innerHTML = `<span class="gold">  ${dados[0].static} </span>`;
            } else if (dados[0].static >= 1300) {
              div_kpi_static.innerHTML = `<span class="diamond">  ${dados[0].static} </span>`;
            }

            if (dados[0].dynamic < 850) {
              div_kpi_dynamic.innerHTML = `<span class="silver">  ${dados[0].dynamic} </span>`;
            } else if (dados[0].dynamic < 950) {
              div_kpi_dynamic.innerHTML = `<span class="gold">  ${dados[0].dynamic} </span>`;
            } else if (dados[0].dynamic >= 950) {
              div_kpi_dynamic.innerHTML = `<span class="diamond">  ${dados[0].dynamic} </span>`;
            }

            if (dados[0].speed < 850) {
              div_kpi_speed.innerHTML = `<span class="silver">  ${dados[0].speed} </span>`;
            } else if (dados[0].speed < 950) {
              div_kpi_speed.innerHTML = `<span class="gold">  ${dados[0].speed} </span>`;
            } else if (dados[0].speed >= 950) {
              div_kpi_speed.innerHTML = `<span class="diamond">  ${dados[0].speed} </span>`;
            }

            if (dados[0].evasive < 850) {
              div_kpi_evasive.innerHTML = `<span class="silver">  ${dados[0].evasive} </span>`;
            } else if (dados[0].evasive < 950) {
              div_kpi_evasive.innerHTML = `<span class="gold">  ${dados[0].evasive} </span>`;
            } else if (dados[0].evasive >= 950) {
              div_kpi_evasive.innerHTML = `<span class="diamond">  ${dados[0].evasive} </span>`;
            }
            if (dados[0].smooth < 850) {
              div_kpi_smooth.innerHTML = `<span class="silver">  ${dados[0].smooth} </span>`;
            } else if (dados[0].smooth < 950) {
              div_kpi_smooth.innerHTML = `<span class="gold">  ${dados[0].smooth} </span>`;
            } else if (dados[0].smooth >= 950) {
              div_kpi_smooth.innerHTML = `<span class="diamond">  ${dados[0].smooth} </span>`;
            }

            if (dados[0].reactive < 850) {
              div_kpi_reactive.innerHTML = `<span class="silver">  ${dados[0].reactive} </span>`;
            } else if (dados[0].smooth < 950) {
              div_kpi_reactive.innerHTML = `<span class="gold">  ${dados[0].reactive} </span>`;
            } else if (dados[0].smooth >= 950) {
              div_kpi_reactive.innerHTML = `<span class="diamond">  ${dados[0].reactive} </span>`;
            }

            // div_kpi_evasive.innerHTML = dados[0].evasive;
            // div_kpi_smooth.innerHTML = dados[0].smooth;
            // div_kpi_reactive.innerHTML = dados[0].reactive;

            const ctx = document.getElementById("chart_avg");

            new Chart(ctx, {
              type: "bar",
              data: {
                labels: [
                  "static",
                  "dinamyc",
                  "speed",
                  "evasive",
                  "smooth",
                  "reactive",
                ],
                datasets: [
                  {
                    label: "# of Votes",
                    data: [
                      dados[0].static,
                      dados[0].dynamic,
                      dados[0].speed,
                      dados[0].evasive,
                      dados[0].smooth,
                      dados[0].reactive,
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                plugins: {
                  legend: {
                    display: false,
                  },
                  title: {
                    display: true,
                    text: "Comparação das categorias",
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
              },
            });
          })
          .catch((erro) => {
            console.log(erro);
          });
      })
      .catch((erro) => {
        console.log(erro);
      });
  }

  function atlVoltaic(idVoltaic, idusuario) {
    fetch("/usuarios/atlVoltaic", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idVoltaic: idVoltaic,
        idusuario: idusuario,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
        console.log("aaaa");
        if (resposta.ok) {
          atlGrafico(sessionStorage.ID_USUARIO);
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function voltaic() {
    const voltaic = div_voltaic;
    const grafico = div_chart;
    voltaic.style.display = "none";
    grafico.style.display = "block";

    // aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var staticVar = inp_static.value;
    var dynamicVar = inp_dynamic.value;
    var speedVar = inp_speed.value;
    var evasiveVar = inp_evasive.value;
    var smoothVar = inp_smooth.value;
    var reactiveVar = inp_reactive.value;
    // var codigoVar = codigo_input.value;
    // var cpfVar = cpf_input.value;
    // var voltaicVar;

    // Verificando se há algum campo em branco
    if (
      staticVar == "" ||
      dynamicVar == "" ||
      speedVar == "" ||
      evasiveVar == "" ||
      smoothVar == "" ||
      reactiveVar == ""
    ) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "(Mensagem de erro para todos os campos em branco)";

      finalizarAguardar();
      return false;
    } // else {
    //   setInterval(sumirMensagem, 5000);
    // }

    fetch("/usuarios/voltaic", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        staticServer: staticVar,
        dynamicServer: dynamicVar,
        speedServer: speedVar,
        evasiveServer: evasiveVar,
        smoothServer: smoothVar,
        reactiveServer: reactiveVar,

        // idVoltaicVincularServer: voltaicVar,
        // cpfServer: cpfVar
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          // cardErro.style.display = "block";

          // mensagem_erro.innerHTML =
          //   "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

          // setTimeout(() => {
          //   window.location = "login.html";
          // }, "2000");

          // limparFormulario();
          // finalizarAguardar();

          resposta
            .json()
            .then((dados) => {
              atlVoltaic(dados.insertId, sessionStorage.ID_USUARIO);
            })
            .catch(function (resposta) {
              console.log(`#ERRO: ${resposta}`);
              finalizarAguardar();
            });
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    return false;
  }

  // Listando empresas cadastradas
  // function listar() {
  //   fetch("/empresas/listar", {
  //     method: "GET",
  //   })
  //     .then(function (resposta) {
  //       resposta.json().then((empresas) => {
  //         empresas.forEach((empresa) => {
  //           listaEmpresasCadastradas.push(empresa);

  //           console.log("listaEmpresasCadastradas")
  //           console.log(listaEmpresasCadastradas[0].codigo_ativacao)
  //         });
  //       });
  //     })
  //     .catch(function (resposta) {
  //       console.log(`#ERRO: ${resposta}`);
  //     });
  // }

  // function sumirMensagem() {
  //   cardErro.style.display = "none";
  // }

  // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
</script>
